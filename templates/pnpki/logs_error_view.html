    {% extends 'base/lte_base.html' %}
    {% load static %}

    {% block title %}Error Logs{% endblock %}
    {% block content-header %}Error Logs{% endblock %}
    {% block breadcrumb %}Error Logs{% endblock %}
    
    {% block content %}
<div class="col-lg-12">
  <div class="card">
              <div class="card-header">
                <div class="clearfix">
                  <div class="pull-right-manual">
                    <div class="input-group">
                      <input class="input-sm input-date c" id="SearchDateFrom" value="{% now 'Y-m-d' %}" type="search" placeholder="Date From" aria-label="Search">
                      <div class="input-group-append">
                        <a href="#" class="btn btn-sm btn-default btn-flat disabled" onclick="GetApplicants()"><i class="fa fa-search"></i> Search</a>
                        <a href="#" class="btn btn-sm btn-primary btn-flat btn-report disabled"><i class="fa fa-download"></i> Download PDF</a>
                      </div>
                    </div>
                  </div>
                  <div><h3 class="card-title" style="font-size: 25px;"> <i class="fa fa-list"></i> Error Logs</h3></div>
                </div>
              </div>
              <!-- /.card-header -->
              <div class="card-body p-0 table-responsive">
                <table id="TblApplicantList" class="table table-striped table-sm table-container table-hover" style="font-size:13px; font-family: 'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif;">
                  <thead>
                    <tr class="c">
                      <th style="width: 10px;">#</th>
                      <th style="width: 100px;">UserID</th>
                      <th>TransactionID</th>
                      <th>UriSegmentLoc</th>
                      <th>details</th>
                      <th>log</th>
                      <th style="padding-left: 40px;" class="r">ACTION</th>
                    </tr>
                  </thead>
                  <tbody id="LoadAppList">
{% if errors %}
  {% for error in errors %}
    <tr id="trow{{ applicant.id }}">
      <td class="index">{{ forloop.counter }}.</td>
      <td class="c">{{ error.UserID }}</td>
      <td>{{ error.TransactionID }}</td>
      <td>{{ error.UriSegmentLoc	 }}</td>
      <td>{{ error.details }}</td>
      <td>{{ error.log|truncatechars:100 }}</td>
      <td>
        <div class="pull-right">
          <a href="javascript:void(0)" id="{{ error.id }}" trans-id="{{ error.id }}" class="btn btn-xs btn-info btn-flat btn-viewx disabled"><i class="fa fa-eye"></i></a>
          <a href="" target="_blank" rel="noopener" class="btn btn-xs btn-success btn-flat disabled"><i class="fa fa-bars"></i></a>
          <a class="btn btn-xs btn-dark btn-flat btn-deletex disabled" id="{{ error.id }}" trans-id="{{ applicant.id }}"><i class="fa fa-trash"></i></a>
        </div>
      </td>
    </tr>
  {% endfor %}
{% else %}
    <tr><td colspan="7" class="c i"><p>No attachments found.</p></td></tr>
{% endif %}
                  </tbody>
                </table>
              </div>
              <!-- /.card-body -->
            </div>  
</div>
<style>
.pull-right-manual {
    float: right;
}

.clearfix::after {
    content: "";
    clear: both;
    display: table;
}  
</style>          
<script>
  $(function(){ $('.input-date').daterangepicker({ showDropdowns:true, singleDatePicker: true, format: 'YYYY-MM-DD' }); });
  //$(function(){ GetApplicants() });
//========================================================================================================================================================
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== ''){
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) { cookieValue = decodeURIComponent(cookie.substring(name.length + 1)); break; }
      }
    }
    return cookieValue;
  }
//========================================================================================================================================================
  function GetApplicants(){
        
    $.ajax({
      url: "{% url 'applicationlist' %}",
      type: "post",
      data:{ SearchDateFrom : $("#SearchDateFrom").val() },
      //dataType: "json",
      beforeSend: function(xhr) { xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken')); },
      success: function(S){  
        $("#LoadAppList").html(S)
      },
      error: function(xhr, status, error){ 
        console.error('AJAX Error:', status, error);
        console.log('Response Text:', xhr.responseText);
        Notiflix.Notify.Failure("Error processing...");
        let errorLog = ['Status: ' + status,'Error: ' + error,'Response: ' + xhr.responseText].join('\n');
        //$.post("url", { TransactionID:$("#ClientID").val() ,UriSegmentLoc:"transactions/deletetrans", log: errorLog });
      }
    });
  }
//========================================================================================================================================================
  $(document).on('click','.btn-delete',function(){ 
    const VItemID = this.id;
    const VTransID = this.getAttribute("trans-id");

    Notiflix.Confirm.Show('Remove Confirm', 'Want to delete '+VTransID+'?', 'Yes', 'No', 
      function(){ 
        // Yes button callback alert('Thank you.'); 
        $.ajax({
          url: "{% url 'data_remove' %}",
          type: "post",
          data:{ ItemID : VItemID, TransID:VTransID },
          dataType: "json",
          beforeSend: function(xhr) { xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken')); },
          success: function(S){  //S.applicants
            if(S.Notflix=='Failure'){ Notiflix.Notify.Failure(S.response_advise); 
            }else{ Notiflix.Notify.Success(S.response_advise); $("#trow"+VItemID).remove(); $('td.index').html(function(i){ return i + 1; }); }
          },
          //error:function(){ Notiflix.Notify.Failure('Removing Failed..'); }   
          error: function(xhr, status, error){ 
            console.error('AJAX Error:', status, error);
            console.log('Response Text:', xhr.responseText);
            Notiflix.Notify.Failure("Error processing...");
            let errorLog = ['Status: ' + status,'Error: ' + error,'Response: ' + xhr.responseText].join('\n');
            $.ajax({ url: "{% url 'errorlogs' %}",type: "post", data:{ ItemID : VItemID, TransID:VTransID, tblname:"pnpki_application", UriSegmentLoc:"pnpki/data_remove", log: errorLog }, dataType: "json",
            beforeSend: function(xhr) { xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken')); }
            });
          }
        });         
      },
      function(){ /* No button callback alert('If you say so...'); */ }
	  );      
  });
//========================================================================================================================================================
  $(document).on('click','.btn-approve',function(){ 
    const VItemID = this.id;
    const VTransID = this.getAttribute("trans-id");
    const modalElement = document.getElementById('myModal');

    Notiflix.Confirm.Show('Approval Confirmation', 'Want to approve '+VTransID+'?', 'Yes', 'No', 
	    function(){ 
	        // Yes button callback alert('Thank you.'); 
	      $.ajax({
			    url: "{% url 'data_approve' %}",
			    type: "post",
			    data:{ ItemID : VItemID, TransID:VTransID, SearchDateFrom : $("#SearchDateFrom").val() },
			    dataType: "json",
          beforeSend: function(xhr) { xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken')); },
			    success: function(S){  //S.applicants
            if(S.Notflix=='Failure'){ Notiflix.Notify.Failure(S.response_advise); }else{ Notiflix.Notify.Success(S.response_advise); 
              $("#LoadAppList").html(S.applicants);
              $(".modal-save .fa").removeClass('fa-spinner fa-spin');
              $(".modal-save .fa").addClass('fa-paper-plane');
              $(".modal-save").removeClass('disabled');				
			        $('#myModal').modal('toggle');
              modalElement.setAttribute('aria-hidden', 'true');
            }
			    },
			    error: function(xhr, status, error){ 
            console.error('AJAX Error:', status, error);
            console.log('Response Text:', xhr.responseText);
            Notiflix.Notify.Failure("Error processing...");
            let errorLog = ['Status: ' + status,'Error: ' + error,'Response: ' + xhr.responseText].join('\n');
            $.ajax({ url: "{% url 'errorlogs' %}",type: "post", data:{ ItemID : VItemID, TransID:VTransID, tblname:"pnpki_application", UriSegmentLoc:"pnpki/data_approve", log: errorLog }, dataType: "json",
            beforeSend: function(xhr) { xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken')); }
            });
          }
		    });
		                        
		    },
		    function(){ /* No button callback alert('If you say so...'); */ }
	  );
           
  });
//========================================================================================================================================================
        $(document).on('click','.btn-view',function(){ 
          const VItemID = this.id;
          const VTransID = this.getAttribute("trans-id");
          const modalElement = document.getElementById('myModal');

          $.ajax({
			      url: "{% url 'applicantview' %}",
			      type: "post",
			      data:{ ItemID : VItemID, TransID:VTransID, csrfmiddlewaretoken:getCookie('csrftoken') },
			      //dataType: "json",
            //beforeSend: function(xhr) { xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken')); },
			      success: function(content){  //S.applicants
              document.getElementById('myModal').innerHTML=content;
              $('#myModal').modal({ backdrop:'static', keyboard:false },'show');
              $('#myModal').attr('class', 'modal fade bs-example-modal-lg').attr('aria-labelledby','myModalLabel');
              $('.modal-dialog').attr('class','modal-dialog modal-lg');
              // When the modal is shown
              modalElement.removeAttribute('aria-hidden');

            },
			      error: function(xhr, status, error){ 
              console.error('AJAX Error:', status, error);
              console.log('Response Text:', xhr.responseText);
              Notiflix.Notify.Failure("Error processing...");
              let errorLog = ['Status: ' + status,'Error: ' + error,'Response: ' + xhr.responseText].join('\n');
              //$.post("url", { TransactionID:$("#ClientID").val() ,UriSegmentLoc:"transactions/deletetrans", log: errorLog });
            }
		      });

        });
//========================================================================================================================================================
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('HSearchInput');
        const table = document.getElementById('TblApplicantList');
        const rows = table.getElementsByTagName('tr');

        searchInput.addEventListener('keyup', function() {
            const filter = searchInput.value.toLowerCase();

            for (let i = 1; i < rows.length; i++) { // Start from 1 to skip header row
                let row = rows[i];
                let cells = row.getElementsByTagName('td');
                let found = false;

                for (let j = 0; j < cells.length; j++) {
                    let cellText = cells[j].textContent.toLowerCase();
                    if (cellText.includes(filter)) {
                        found = true;
                        break;
                    }
                }

                if (found) {
                    row.style.display = ''; // Show row
                } else {
                    row.style.display = 'none'; // Hide row
                }
            }
        });
    });  
    
    $(document).on('click','.btn-report',function(){ 

          $.ajax({
			      url: "{% url 'applicationreport' %}",
			      type: "post",
			      data:{ SearchDateFrom : $("#SearchDateFrom").val(), csrfmiddlewaretoken:getCookie('csrftoken') },
			      dataType: "json",
            //beforeSend: function(xhr) { xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken')); },
			      success: function(S){  //S.applicants
              window.open(S.redirect_url,'_blank');
            },
			      error: function(xhr, status, error){ 
              console.error('AJAX Error:', status, error);
              console.log('Response Text:', xhr.responseText);
              Notiflix.Notify.Failure("Error processing...");
              let errorLog = ['Status: ' + status,'Error: ' + error,'Response: ' + xhr.responseText].join('\n');
              //$.post("url", { TransactionID:$("#ClientID").val() ,UriSegmentLoc:"transactions/deletetrans", log: errorLog });
            }
		      });      
      //url = "{% url 'applicationreport' %}?token="+getCookie('csrftoken')+"&datefrom="+$("#SearchDateFrom").val();
      //window.open(url,'_blank');
    });
</script>          
    {% endblock %}